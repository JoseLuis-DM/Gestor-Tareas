name: CI - Build & Test

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Configurar JAVA
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Crear archivo variables.env temporal
        run: |
          echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> variables.env
          echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> variables.env
          echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> variables.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> variables.env

      - name: Levantar Docker Compose
        run: docker compose up -d --build

      - name: Esperar inicializaci√≥n
        run: |
          echo "Esperando a que MySQL arranque..."
          sleep 20
          
      - name: Ejecutar pruebas dentro del contenedor
        run: docker exec gestor-app mvn test

      - name: Limpiar docker
        if: always()
        run: docker compose down -v